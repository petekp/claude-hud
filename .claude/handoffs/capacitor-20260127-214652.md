# Bootstrap: Terminal Activation Security & Reliability Fixes

> Generated: 2026-01-27 21:46
> Project: /Users/petepetrash/Code/capacitor
> Branch: main

## Context

Capacitor is a native macOS dashboard for Claude Code. The terminal activation system handles "click project â†’ focus terminal" behavior. A 5-model code review identified critical security and reliability issues in this system. We're implementing fixes in phases.

## Session Summary

Completed **Phase 1 (Critical Fixes)** plus a bonus fix discovered during code review:

1. **Shell Injection Prevention** - Added `shellEscape()` for tmux session names in the primary activation path
2. **Tmux Exit Code Checking** - All `switch-client` calls now return `false` on failure, enabling fallbacks
3. **IDE CLI Error Handling** - `activateIDEWindowInternal()` now waits for process and checks exit status
4. **Multi-Client Tmux Hook** - Changed from `list-clients` (wrong client) to `display-message -p "#{client_tty}"` (current client)
5. **TerminalScripts Injection Fix** (bonus) - Added `bashDoubleQuoteEscape()` and `shell_escape_single()` bash helper to protect the fallback launch path

## Current State

**Completed & Building:**
- All Phase 1 items implemented and building successfully
- Both Rust (`cargo build -p hud-hook --release`) and Swift (`swift build`) pass
- Plan file updated with checkmarks for Phase 1

**Uncommitted Changes:**
- `apps/swift/Sources/Capacitor/Models/TerminalLauncher.swift` - All Swift fixes
- `core/hud-hook/src/cwd.rs` - Rust tmux context detection fix

**Remaining Phases:**
- Phase 2 (Important Fixes): Items 2.1-2.5 - tmux re-verification, AppleScript error checking, subdirectory matching, is_live flag, Ghostty host detection
- Phase 3 (Nice to Have): Items 3.1-3.3 - timestamp parsing, cache size limit, UniFFI export

## Key Files

| File | Purpose |
|------|---------|
| `apps/swift/Sources/Capacitor/Models/TerminalLauncher.swift` | Main terminal activation logic, shell escaping utilities, TerminalScripts enum |
| `core/hud-hook/src/cwd.rs` | Shell CWD tracking hook, tmux context detection |
| `.claude/plans/ACTIVE-terminal-activation-fixes.md` | Full implementation plan with all phases |

## Key Code Locations

- `shellEscape()` - Line ~75-78 in TerminalLauncher.swift
- `bashDoubleQuoteEscape()` - Line ~85-91 in TerminalLauncher.swift
- `executeActivationAction()` switch cases - Lines ~200-280
- `activateIDEWindowInternal()` - Lines ~416-443
- `TerminalScripts` enum - Lines ~760-870
- `detect_tmux_context()` - Lines ~314-331 in cwd.rs

## Decisions Made

1. **Two-level escaping for TerminalScripts**: Swift-level escaping for bash double-quote interpolation PLUS bash-level helper for single-quote tmux arguments. Defense in depth.

2. **Exit code semantics**: `switch-client` failures return `false` to trigger fallback mechanism, even if terminal was partially activated.

3. **Current client TTY**: Using `display-message -p "#{client_tty}"` instead of `list-clients` because the former respects `$TMUX` env var inheritance and returns the correct client when multiple are attached.

## Gotchas & Warnings

- **`waitUntilExit()` on main actor**: The IDE CLI fix blocks the main thread. Noted for future async refactoring but acceptable for now since CLI calls are fast.
- **TerminalScripts was missed initially**: The review agent caught that the fallback path wasn't protected. Always check ALL code paths when fixing injection vulnerabilities.
- **UniFFI Task shadows Swift Task**: Use `_Concurrency.Task` explicitly in async code (pre-existing issue, not from this session).

## Next Steps

1. **Optional: Commit Phase 1** - Changes are complete and tested
2. **Continue to Phase 2** - Read `.claude/plans/ACTIVE-terminal-activation-fixes.md` and implement items 2.1-2.5
3. **Run manual tests** - Per the plan's testing checklist:
   - Create tmux session with `'` in name, verify no injection
   - Detach tmux, click project, verify fallback executes
   - Remove `cursor` from PATH, click Cursor project, verify fallback

## Resume Instructions

```bash
cd /Users/petepetrash/Code/capacitor

# View uncommitted changes
git diff apps/swift/Sources/Capacitor/Models/TerminalLauncher.swift
git diff core/hud-hook/src/cwd.rs

# Read the full plan
cat .claude/plans/ACTIVE-terminal-activation-fixes.md

# Build to verify state
cargo build -p hud-hook --release && cd apps/swift && swift build
```

Then either commit Phase 1 or continue to Phase 2 implementation.
